<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>R√°dio M3U</title>

<link rel="manifest" href="manifest.json" />
<link rel="apple-touch-icon" href="image/icon.png" />
<link rel="icon" href="image/favicon.ico" type="image/x-icon">
<meta name="apple-mobile-web-app-capable" content="yes" />

<style>
:root {
  --bg:#121212;
  --text:#ffffff;
  --card:#1e1e1e;
  --primary:#1DB954;
  --primary-hover:#17a64a;
  --muted:#ccc;
  --grid:#2a2a2a;
}

[data-theme="light"] {
  --bg:#f5f6fa;
  --text:#111;
  --card:#ffffff;
  --primary:#0a58ca;
  --primary-hover:#084298;
  --muted:#555;
  --grid:#ddd;
}

body {
  margin:0;
  font-family:Arial, sans-serif;
  background:var(--bg);
  color:var(--text);
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
}

.container {
  max-width:420px;
  width:90%;
  padding:2rem;
  background:var(--card);
  border-radius:12px;
  box-shadow:0 0 12px #00000040;
  text-align:center;
}

header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:1rem;
}

h1 {
  color:var(--primary);
  margin:0;
}

.theme-btn {
  background:none;
  border:none;
  font-size:1.4rem;
  cursor:pointer;
  color:var(--text);
}

select {
  width:100%;
  padding:.6rem;
  margin-bottom:1rem;
  border-radius:6px;
  border:none;
}

button {
  background:var(--primary);
  color:#fff;
  border:none;
  padding:.6rem 1.2rem;
  font-size:1.1rem;
  border-radius:6px;
  cursor:pointer;
}

button:hover { background:var(--primary-hover); }

#status, #buffering, #dataUsage {
  font-size:.85rem;
  margin-top:6px;
  color:var(--muted);
}

canvas {
  margin-top:12px;
  width:100%;
  height:120px;
  background:transparent;
}
</style>
</head>

<body>
<div class="container">
  <header>
    <h1>üéß R√°dio M3U</h1>
    <button id="themeToggle" class="theme-btn">üåô</button>
  </header>

  <select id="stationSelect">
    <option value="https://stream.geracao.live/listen/rock/stream">Gera√ß√£o Rock</option>
    <option value="https://playerservices.streamtheworld.com/api/livestream-redirect/RADIO_89FM_ADP.aac">R√°dio 89 FM Rock</option>
    <option value="https://streams.radiobob.de/metalcore/mp3-128">RADIO BOB - Metal</option>
    <option value="https://maximum-dark.hostingradio.ru/maxdark96.aacp">Radio Maximum Emo</option>
  </select>

  <button id="playPauseBtn">‚è∏Ô∏è Pausar</button>

  <div id="status">üîä Conectando...</div>
  <div id="buffering"></div>
  <div id="dataUsage">üì∂ Dados usados: 0.00 MB</div>

  <canvas id="usageChart" width="360" height="120"></canvas>

  <audio id="audioPlayer" preload="auto"></audio>
</div>

<script>
/* ===== ELEMENTOS ===== */
const select = document.getElementById("stationSelect");
const player = document.getElementById("audioPlayer");
const status = document.getElementById("status");
const buffering = document.getElementById("buffering");
const dataUsage = document.getElementById("dataUsage");
const playPauseBtn = document.getElementById("playPauseBtn");
const themeToggle = document.getElementById("themeToggle");
const canvas = document.getElementById("usageChart");
const ctx = canvas.getContext("2d");

/* ===== TEMA ===== */
const savedTheme = localStorage.getItem("theme-radio") || "dark";
document.documentElement.setAttribute("data-theme", savedTheme);
themeToggle.textContent = savedTheme === "dark" ? "‚òÄÔ∏è" : "üåô";

themeToggle.onclick = () => {
  const next = document.documentElement.getAttribute("data-theme") === "dark" ? "light" : "dark";
  document.documentElement.setAttribute("data-theme", next);
  localStorage.setItem("theme-radio", next);
  themeToggle.textContent = next === "dark" ? "‚òÄÔ∏è" : "üåô";
};

/* ===== CONSUMO DE DADOS ===== */
let playbackSeconds = 0;
let dataInterval;
let estimatedKbps = 128;
let usageHistory = [];

function detectBitrate(url) {
  if (url.includes(".aac")) return 128;
  if (url.includes("mp3")) return 128;
  if (url.includes("ogg")) return 96;
  return 128;
}

function startDataCounter() {
  clearInterval(dataInterval);
  estimatedKbps = detectBitrate(select.value);

  dataInterval = setInterval(() => {
    if (!player.paused && !player.ended) {
      playbackSeconds++;
      const mb = (estimatedKbps * playbackSeconds) / 8 / 1024;
      dataUsage.textContent = `üì∂ Dados usados: ${mb.toFixed(2)} MB`;
      usageHistory.push(mb);
      if (usageHistory.length > 60) usageHistory.shift();
      drawChart();
    }
  }, 1000);
}

function stopDataCounter() {
  clearInterval(dataInterval);
}

/* ===== GR√ÅFICO ===== */
function drawChart() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  const max = Math.max(...usageHistory, 1);
  ctx.strokeStyle = getComputedStyle(document.documentElement)
    .getPropertyValue("--primary");

  ctx.beginPath();
  usageHistory.forEach((v, i) => {
    const x = (i / 59) * canvas.width;
    const y = canvas.height - (v / max) * canvas.height;
    if (i === 0) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
  });
  ctx.stroke();
}

/* ===== PLAYER ===== */
let reconnectTimeout;
const BUFFER_TIME = 4000;
let isManuallyPaused = false;

function updateStatus() {
  const name = select.options[select.selectedIndex].text;
  status.textContent = `üîä Tocando: ${name}`;
}

function playStation() {
  clearTimeout(reconnectTimeout);
  player.src = select.value;

  setTimeout(() => buffering.textContent = "‚è≥ Buffering...", BUFFER_TIME);

  player.play().then(() => {
    isManuallyPaused = false;
    playPauseBtn.textContent = "‚è∏Ô∏è Pausar";
    updateStatus();
  }).catch(scheduleReconnect);
}

function scheduleReconnect() {
  if (isManuallyPaused) return;
  reconnectTimeout = setTimeout(() => {
    status.textContent = "üîÅ Reconectando...";
    player.play().catch(scheduleReconnect);
  }, 5000);
}

/* ===== EVENTOS ===== */
select.onchange = () => {
  playbackSeconds = 0;
  usageHistory = [];
  dataUsage.textContent = "üì∂ Dados usados: 0.00 MB";
  playStation();
};

playPauseBtn.onclick = () => {
  if (player.paused) {
    isManuallyPaused = false;
    player.play();
    playPauseBtn.textContent = "‚è∏Ô∏è Pausar";
    updateStatus();
  } else {
    isManuallyPaused = true;
    player.pause();
    playPauseBtn.textContent = "‚ñ∂Ô∏è Tocar";
    status.textContent = "‚è∏Ô∏è Pausado";
  }
};

player.addEventListener("playing", () => {
  buffering.textContent = "";
  updateStatus();
  startDataCounter();
});

player.addEventListener("pause", stopDataCounter);
player.addEventListener("waiting", () => buffering.textContent = "‚è≥ Buffering...");
["error","ended","stalled"].forEach(e =>
  player.addEventListener(e, () => {
    stopDataCounter();
    if (!isManuallyPaused) scheduleReconnect();
  })
);

/* ===== INIT ===== */
playStation();
</script>
</body>
</html>
