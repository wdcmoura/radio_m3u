<!DOCTYPE html>
<html lang="pt-BR" data-theme="dark">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>R√°dio M3U</title>

<style>
/* ================= TEMA ================= */
:root[data-theme="dark"] {
  --bg-color: #121212;
  --text-color: #ffffff;
  --container-bg: #1e1e1e;
  --button-bg: #1DB954;
  --button-hover: #17a64a;
  --status-color: #ccc;
  --buffering-color: yellow;
}

:root[data-theme="light"] {
  --bg-color: #f5f6fa;
  --text-color: #111;
  --container-bg: #ffffff;
  --button-bg: #0a58ca;
  --button-hover: #084298;
  --status-color: #444;
  --buffering-color: #cc8a00;
}

/* ================= LAYOUT ================= */
body {
  background: var(--bg-color);
  color: var(--text-color);
  font-family: Arial, sans-serif;
  margin: 0;
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
}

.container {
  text-align: center;
  max-width: 400px;
  width: 90%;
  padding: 2rem;
  background: var(--container-bg);
  border-radius: 10px;
  box-shadow: 0 0 10px #00000040;
}

h1 {
  color: var(--button-bg);
}

select, button {
  width: 100%;
  margin-top: 10px;
  padding: 10px;
  font-size: 1rem;
}

button {
  background: var(--button-bg);
  color: #fff;
  border: none;
  border-radius: 5px;
  cursor: pointer;
}

button:hover {
  background: var(--button-hover);
}

#status {
  margin-top: 10px;
  font-size: 0.9rem;
  color: var(--status-color);
}

#buffering {
  font-size: 1.1rem;
  color: var(--buffering-color);
}
</style>
</head>

<body>
<div class="container">
  <h1>üéß R√°dio M3U</h1>

  <select id="stationSelect">
    <option value="https://stream.geracao.live/listen/rock/stream">Gera√ß√£o Rock</option>
    <option value="https://playerservices.streamtheworld.com/api/livestream-redirect/RADIO_ALPHAFM_ADP.aac">Alpha FM</option>
    <option value="https://playerservices.streamtheworld.com/api/livestream-redirect/RADIO_89FM_ADP.aac">R√°dio 89 FM Rock</option>
    <option value="https://streams.radiobob.de/metalcore/mp3-128">Radio BOB Metal</option>
  </select>

  <button id="playPauseBtn">‚è∏Ô∏è Pausar</button>
  <button onclick="toggleTheme()">üåó Alternar Tema</button>

  <p id="status"></p>
  <p id="buffering"></p>

  <audio id="audioPlayer" preload="auto"></audio>
</div>

<script>
/* ================= VARI√ÅVEIS ================= */
const select = document.getElementById('stationSelect');
const player = document.getElementById('audioPlayer');
const status = document.getElementById('status');
const playPauseBtn = document.getElementById('playPauseBtn');
const buffering = document.getElementById('buffering');

let reconnectTimeout;
let bufferTimeout;
let isManuallyPaused = false;

const BUFFER_TIME = 10000;
const STREAM_BITRATE_KBPS = 128;

/* ================= TEMA ================= */
function toggleTheme() {
  const current = document.documentElement.dataset.theme;
  const next = current === 'dark' ? 'light' : 'dark';
  document.documentElement.dataset.theme = next;
  localStorage.setItem('theme', next);
}

function loadTheme() {
  document.documentElement.dataset.theme =
    localStorage.getItem('theme') || 'dark';
}

/* ================= CONSUMO DE DADOS ================= */
let playStartTime = null;

function startDataCounter() {
  playStartTime = Date.now();
}

function stopDataCounter() {
  if (!playStartTime) return;
  const seconds = (Date.now() - playStartTime) / 1000;
  playStartTime = null;

  const mb =
    ((STREAM_BITRATE_KBPS * 1000) / 8 * seconds) / (1024 * 1024);

  console.log(`üì° Consumo estimado: ${mb.toFixed(2)} MB`);
}

/* ================= PLAYER ================= */
function playStation(url, name) {
  stopDataCounter(); // fecha consumo anterior
  clearTimeout(reconnectTimeout);
  clearTimeout(bufferTimeout);

  player.src = url;
  player.load();

  bufferTimeout = setTimeout(() => {
    buffering.textContent = "‚è≥ Carregando buffer...";
  }, BUFFER_TIME);

  player.play().then(() => {
    isManuallyPaused = false;
    status.textContent = `üîä Tocando: ${name}`;
  });
}

select.addEventListener('change', () => {
  playStation(select.value, select.options[select.selectedIndex].text);
});

playPauseBtn.addEventListener('click', () => {
  if (player.paused) {
    isManuallyPaused = false;
    player.play();
  } else {
    isManuallyPaused = true;
    player.pause();
    stopDataCounter();
  }
});

/* ================= EVENTOS ================= */
player.addEventListener('playing', startDataCounter);

player.addEventListener('waiting', () => {
  buffering.textContent = "‚è≥ Carregando buffer...";
});

player.addEventListener('canplay', () => {
  buffering.textContent = "";
});

player.addEventListener('ended', () => {
  stopDataCounter();
});

['error', 'stalled'].forEach(ev => {
  player.addEventListener(ev, () => {
    if (!isManuallyPaused) {
      status.textContent = "‚ö†Ô∏è Erro. Reconectando...";
      reconnectTimeout = setTimeout(() => player.play(), 5000);
    }
  });
});

/* ================= INIT ================= */
loadTheme();
playStation(select.value, select.options[select.selectedIndex].text);
</script>
</body>
</html>
